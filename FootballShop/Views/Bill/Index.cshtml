@model FootballShopModel.Models.Bill

@{
    ViewBag.Title = "Index";
}


<div class="wrap-header-cart js-panel-cart">
    <div class="s-full js-hide-cart"></div>

    <div class="header-cart flex-col-l p-l-65 p-r-25">
        <div class="header-cart-title flex-w flex-sb-m p-b-8">
            <span class="mtext-103 cl2">
                Your Cart
            </span>

            <div class="fs-35 lh-10 cl2 p-lr-5 pointer hov-cl1 trans-04 js-hide-cart">
                <i class="zmdi zmdi-close"></i>
            </div>
        </div>

        <div class="header-cart-content flex-w js-pscroll">
            <ul id="detail-list-all-products-in-cart" class="header-cart-wrapitem w-full">
            </ul>


            <div class="w-full">
                <div class="header-cart-total w-full p-tb-40">
                    Tổng : <span id="detail-cart-total-price-sidebar">0</span>
                </div>

                <div class="header-cart-buttons flex-w w-full">
                    <a href="/ShopingCart" class="flex-c-m stext-101 cl0 size-107 bg3 bor2 hov-btn3 p-lr-15 trans-04 m-r-8 m-b-10">
                        Xem giỏ hàng
                    </a>

                    <a href="/ShopingCart" class="flex-c-m stext-101 cl0 size-107 bg3 bor2 hov-btn3 p-lr-15 trans-04 m-b-10">
                        Thanh toán
                    </a>
                </div>
            </div>
        </div>

    </div>
</div>



<!-- Bill -->
<form class="bg0 p-t-75 p-b-85">
    <div class="container">
        <div class="row">
            <div class="col-lg-12 col-xl-10 m-lr-auto m-b-50">
                <div class="m-l-25 m-r--38 m-lr-0-xl">
                    <div class="wrap-table-shopping-cart">
                        <table id="list-cart-detail-items" class="table-shopping-cart">



                            @*<h4>Không có đơn hàng nào</h4>*@

                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

<div class="modal fade bd-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true" style="z-index:9999">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Đơn hàng</h5>
            </div>
            <div class="modal-body">
                <table class="table table-hover ">
                    <thead>
                        <tr>
                            <th>
                                Hình
                            </th>
                            <th>Tên sản phẩm</th>
                            <th>Tiền</th>
                            <th>Số lượng</th>
                        </tr>
                    </thead>
                    <tbody id="orderDetail_bill">

                        @*<tr class="total">
                                <th scope="row">
                                    <img src="/Assets/Admin/img/product/"
                                         alt="IMG" width="100%">
                                </th>
                                <td>abc</td>
                                <td>1100$</td>
                                <td>3</td>
                            </tr>*@
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>


<!-- Modal -->
<div class="modal fade" id="confirm-modal-receive" tabindex="-1" role="dialog" aria-hidden="true"
     style="z-index: 9999">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title cl8" id="exampleModalLabel">Nhận hàng</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body cl8">
                Bạn đã nhận được hàng?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal">Hủy bỏ</button>
                <button id="confirm-receive-modal-agree-btn" data-idbill="" type="button"
                        class="btn btn-danger">
                    Đã nhận hàng
                </button>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    const listProductsInCartSidebar = document.getElementById(
        "getId-user"
    );
    let id = listProductsInCartSidebar.getAttribute('data-id');
    if (!id) {
        document.getElementById("list-cart-detail-items").style.display = "none";
    } else {
        const loadBill = async (idUser) => {
            const res = await fetch(`https://localhost:44323/Bill/GetAllBillbyUser?idUser=${idUser}`);
            const data = await res.json();
            console.log(data);
            if (data.bill != null) {
                let html = data.bill.map(item => {
                    let shiping = "";
                    let color = "";
                    let price = (item.totalPrice * 1).toLocaleString(
                        "vi-VN",
                        {
                            style: "currency",
                            currency: "VND",
                        }
                    );
                    if (item.status == 0) {
                        shiping = "Đang giao hàng"
                        color = "text-primary"
                    }
                    if (item.status == 3) {
                        shiping = "Đã nhận hàng"
                        color = "text-success"
                    }
                    return `
                            <div class="card mb-4">
                                <div class="card-header d-flex align-items-center justify-content-between ">
                                    <span class="ml-4">Đơn hàng</span>
                                    <div class="bill-status" id="shiping">

                                        <span type="button"
                                              id="shiping-${item.id}"
                                              class="${color} font-weight-bold m-0 mr-4">
                                            ${shiping}
                                        </span>



                                    </div>
                                </div>
                                <div class="card-body ml-4 clearfix">
                                    <h5 class="card-title">Dia chi</h5>
                                    <p class="card-text">${item.recipientName}</p>
                                    <p class="card-text">${item.recipientAddress}</p>
                                    <p class="card-text">${item.recipientPhone}</p>
                                    <button data-toggle="modal" data-target=".bd-example-modal-lg"
                                            type="button"

                                            data-idbill="${item.id}"
                                            class="btn btn-warning m-0 mr-4 float-r detail_bill">
                                        Chi tiết đơn hàng
                                    </button>
                                </div>
                                <div class="card-footer d-flex align-items-center justify-content-end">
                                    <p class="card-text mr-4" style="color: #D70018;">
                                        Tổng tiền: ${price}
                                    </p>


                                    <button data-idbill="${item.id}"
                                            type="button"
                                             data-toggle="modal" data-target="#confirm-modal-receive"
                                            class="btn btn-primary m-0 mr-4 btn__receive">
                                        Bạn đã nhận
                                        hàng?
                                    </button>

                                </div>
                            </div>
                    `
                });
                document.getElementById("list-cart-detail-items").innerHTML = html.join("");


                $(`.detail_bill`).on("click", async function () {
                    const id_bill = $(this).attr("data-idbill");
                    const res = await fetch(`https://localhost:44323/BillDetail/getAllByIdBill?idBill=${id_bill}`);
                    const data = await res.json();
                    console.log(data);
                    if (data.status == "success") {
                        const html = data.data.map(item => {
                            const price = (((100 - item.product.discount) / 100 * item.product.price) * 1).toLocaleString(
                                "vi-VN",
                                {
                                    style: "currency",
                                    currency: "VND",
                                }
                            );
                            return `
                         <tr class="total">
                            <th scope="row">
                                <img src="/Assets/Admin/img/product/${item.product.image}"
                                     alt="IMG" width="50%">
                            </th>
                            <td>${item.product.name}</td>
                            <td>${price}</td>
                            <td>${item.quantity}</td>
                        </tr>
                        `
                        });
                        console.log(html)
                        document.getElementById("orderDetail_bill").innerHTML = html.join("");
                    }
                });

                $(".btn__receive").on("click", function () {
                    const id_bill = $(this).attr("data-idbill");
                    $("#confirm-receive-modal-agree-btn").attr("data-idbill", id_bill);
                    
                });
                $("#confirm-receive-modal-agree-btn").on("click", async function () {
                    const id_bill = $(this).attr("data-idbill");
                    $("#confirm-modal-receive").modal("hide");
                    const res = await fetch(`https://localhost:44323/bill/updatestatusbyid?id=${id_bill}`);
                    const data = await res.json();
                    if (data.status == "success") {
                        const shiping = $(`#shiping-${id_bill}`);
                        shiping.removeClass("text-primary");
                        shiping.addClass("text-success");
                        shiping.html("Đã nhận hàng");
                    }
                })

            }
        }
        loadBill(id);




    }





</script>